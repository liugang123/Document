- #### 复制
```
1.通过执行slaveof命令或者设置slavof选项，让一个服务器去复制另一个服务器，复制中主从服务器双方的数据库数据将保持一致
2.主服务器(master):被复制的服务器称为主服务器
3.从服务器(slave):对主服务器进行复制的服务器称为从服务器
4.主服务器可以处理客户端的读写命令，从服务器只能处理读命令
```

- #### 实现复制
```
1.复制功能需要就行两个操作：
* 同步：用于将从服务器的数据库状态更新至主服务器当前所处的数据库状态
  (1)从服务器向主服务器发送sync命令
  (2)收到sync命令主服务器执行bgsave操作，在后台生成rdb文件，并在缓存区记录之后所有的写命令
  (3)主服务将rdb文件发送给从服务器，从服务器载入rdb文件，更新数据库状态至主服务器执行bgsave操作时的数据状态
  (4)主服务器将缓存区的写命名发送给从服务器，从服务器执行写密码，将数据库状态更新至主服务器的最新状态
* 命令传播：在主服务器的数据库状态被修改时，让主从服务器的数据库从新回到一致状态
  同步操作完成之后，主服务器会将自己执行的写命令发送给从服务期执行，始终保持双方数据库状态的一致
```

- #### 同步模式
```
1.Redis从2.8版本开始，使用psync命令替代sync命令来执行复制同步操作，psync具有两种同步模式：
* 完整重同步：用于处理初次复制，与sync命名执行步骤一样，通过rdb文件和命令缓冲区来进行同步
* 部分重同步：用于断线后复制，主服务器将连接断开期间的写命令发送给从服务器，就可以将从服务器的状态更新至一致状态
2.部分重同步功能由三个部分构成
* 主服务器的复制偏移量和从服务器的复制偏移量
  (1)主服务器每次向从服务器传播N个字节数据时，就讲自己的复制偏移量值加上N
  (2)从服务器每次收到主服务器传播来的N个字节数据时，也将自己的复制偏移量值加上N
  (3)如果主从服务器处于一致状态，两者的偏移量总是相同的
* 主服务器的复制积压缓存区
  (1)主服务器维护一个固定长度先进先出的队列，当入队元素的数量大于队列长度时，最先入队的元素会被弹出，而新元素被放入队列
  (2)如果offset偏移量仍然存在于复制挤压缓存区中，主服务器将进行部分重同步操作，否则，执行完整重同步操作
  (3)复制挤压缓冲区的最小大小可以通过公式估算
     second * write_size_per_second
     second：从服务器断线到重连所需的平均时间
     write_size_per_second：主服务器平均每秒产生的写命令数据量
* 服务器的运行ID
  (1)每个Redis服务器，都会有自己的运行ID，服务器启动时自动生成
  (2)如果主从服务的运行ID相同，主服务器尝试执行部分重同步操作，否则，执行完整重同步操作
3.psync命令调用：
* 如果从服务器没有复制过任何主服务器，将向主服务发送'psync ? -1'命令，主动请求主服务器进行完整重同步
* 如果从服务器复制某个主服务器，将向主服务器发送'psync runid offset',主服务器通过服务器运行ID和offset偏移量来决定执行那种操作
4.psync命令回复：
收到psync命令的主服务器会向从服务器回复其中的一种：
* +fullresync runid offset：执行完整重同步，offset作为自己的初始化偏移量
* +continue：执行部分重同步，主服务器会发送从服务器缺少的部分数据
* -err：redis版本低于2.8，不识别psync命令
```

- #### 心跳检测
```
在命令传播阶段，从服务器会以每秒一次的频率，向服务器发送命令：
replconf ack replication_offset
心跳检测的作用：
* 检测主从服务器的网络连接状态
* 辅助实现min-slaves选项
* 检测命令丢失
```

- #### 哨兵(sentinel)
```
1.哨兵是Redis高可用性的解决方案：由一个或多个sentinel实例组成的Sentinel系统，会监视所有的主服务器及其下属的从服务器，
当主服务器下线时自动将下属的从服务器升级为新的主服务器
2.启动初始化Sentinel
  redis-sentinel /path/to/your/sentinel.conf 或者
  redis-server /path/to/your/sentinel.conf
当sentinel启动时，执行以下步骤：
* 初始化服务器
  sentinel模式下的redis服务器不使用数据操作命令、事务命令、脚本命令、rdb持久化命令，aof持久化命令等
* 将普通redis服务器使用的代码替换成sentinel专用代码
  sentinel一般使用26379作为服务器端口
* 初始化sentinel状态
  服务器会初始化sentinelState结构保存和sentinel功能有关的状态
* 根据给定的配置文件，初始化sentinel监视主服务器的列表
  sentinel状态中的masters字典记录了所有被监视的主服务器信息
* 创建连向主服务器的网络连接
  每个被sentinel监视的主服务器，sentinel会创建两个连向主服务器的异步网络:
  1)命令连接：专门用于向主服务器发送命令，并接受命令回复
  2)订阅连接：订阅主服务器的__sentinel__:hello频道
3.主观下线
(1)sentinel会以每秒一次的频率向所有与它创建了命令连接的实例(主服务器、从服务器、其他sentinel)发送ping命令，
通过实例返回的ping命令回复判断实例是否在线
(2)用户通过设置down-after-milliseconds选项值，来判断所有实例的主观下线状态
(3)多个sentinel设置的主观下线时长可能不同，如果当前sentinel监视的某个实例被判定为主观下线，其他sentinel可能仍然认为该实例处于在线状态
4.客观下线
(1)当sentinel将一个主服务器判断为主观下线后，会向监视该服务器的其他sentinel进行询问，如果其他sentinel的已下线数量达到设置值，
   sentinel会将主服务器判定为客观下线，并对主服务器进行故障转操作
(2)sentinel通过设置quorum参数值，判断被监视实例是否已进入客观下线状态
(3)不同sentinel判断客观下线的条件可能不同，当一个sentinel将主服务器判断为客观下线时，其他的sentinel可能并不认为该服务器已下线
5.选举领头sentinel
(1)当主服务器被判断为客观下线时，监视该主服务器的所有sentinel会进行协商，选举出一个领头sentinel，
   并由领头sentinel对已下线主服务器进行故障转移操作
(2) sentinel系统选举领头sentinel的方法是对Raft算法的领头选举方法的实现  
6.故障转移
(1)领头sentinel将对已下线的主服务器执行故障转移操作：
* 在已下线主服务器的所有从服务器里，挑选出一个从服务器，并将其转换为主服务器
* 让已下线主服务器下属的所有从服务器改为复制新的主服务器
* 将已下线主服务器设置为新的主服务器的从服务器
(2)新主服务器的选举策略
领头的sentinel会将已下线主服务器所有从服务器保存在一个列表中，在对列表进行过滤：
* 删除列表中所有处于下线或断线的从服务器
* 删除列表中所有最近5秒没有回复过领头sentinel的info命令的从服务器
* 删除所有与已下线主服务器连接断开超过down-after-milliseconds * 10毫秒的从服务器
* 根据从服务器的优先级对从服务器进行排序
* 选出复制偏移量最大的从服务器
* 按照运行ID对从服务器进行排序，选出运行ID最小的从服务器
```

- #### 集群
```
1.集群是Redis提供的分布式数据库方案，集群通过分片来进行数据共享，并提供复制和故障转移功能
2.节点(node)
* 一个集群由多个节点组成,每个节点都是互相独立的，各个独立的节点连接起来，构成一个包含多个节点的集群
* 节点只能使用0号数据库
3.槽指派(slot)
* 集群的整个数据库被分为16384个槽，数据库中的每个键都属于16384槽其中的一个，集群中的每个节点都可以处理0个或最多16384个槽
* 当数据库中的16384个槽都有节点处理时，集群处于上线状态(ok)，如果任何一个槽没有得到处理，集群处于下线状态(fail)
4.执行集群命令
当客户端向节点发送与数据库相关的目录时，接受命令的节点会计算出命名的数据库key属于那个槽，并检查这个槽是否指派给自己：
* 如果键所在的槽正好就指派给当前节点，节点就直接执行命令
* 如果建所在的槽没有指派给当前节点，客户端会收到moved错误，跳转(redirect)至正确的节点，在次发送之前的命令
5.重新分片
* 重新分片可以将任意数量已经指派给某个节点的槽改为指派给另一个节点，相关槽所属的键值对也会从源节点被移动到目标节点
* 重新分片可以在线(online)进行，并且源节点和目标节点都可以继续处理命令请求
6.复制
集群中的节点分为主节点和从节点，主节点用于处理槽，从节点原来复制某个主节点，
当主节点下线时，从节点会代替主节点继续处理命令请求
7.故障转移
(1)集群中的各个节点会通过相互发送消息的方式来交换集群中各个节点的状态信息，如某个节点是否在线、疑似下线(PFail)、已下线(fai)
(2)当从节点发现复制的主节点进入已下线状态，从节点开始对下线主节点进行故障转移：
* 复制下线主节点的所有从节点里，会有一个从节点被选中
* 被选中的从节点会执行slaveof no one命令，成为新的主节点 
* 线的主节点撤销已下线主节点的槽指派，将槽全部指派给自己
* 新的主节点广播pong消息，让集群其他节点知道从节点升级为主节点，并且负责槽的处理
* 新的主节点接受处理槽的有关命令请求
8.选举新的主节点
* 当从节点发现复制主节点已下线，会向集群广播一条消息，要求具有投票权的主节点向从节点投票
* 如果集群中有n个具有投票权的主节点，当一个从服务器收集到大于等于n/2+1张支持票，从节点就会当选为新的主节点
* 选举新主节点和选举领头sentinel的方法都是基于Roft算法的领头选举方案实现的
```